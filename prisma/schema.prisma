generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  DIALER
  CLOSER
  MANAGER
  ADMIN
  CLIENT
}

enum LeadStatus {
  NEW
  ASSIGNED
  CALLED
  DO_NOT_CALL
  INVALID
}

enum CallDisposition {
  NO_ANSWER
  LEFT_VOICEMAIL
  FOLLOW_UP
  BOOKED
  NOT_INTERESTED
  BAD_NUMBER
}

enum AppointmentMethod {
  PHONE
  ZOOM
  GOOGLE_MEET
  IN_PERSON
  OTHER
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELED
  NO_SHOW
  RESCHEDULED
}

enum CloserOutcome {
  CLOSED
  FOLLOW_UP
  LOST
}

enum ContractStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  SENT
}

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  name         String
  passwordHash String
  role         Role    @default(DIALER)
  active       Boolean @default(true)
  timeZone     String  @default("America/New_York")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leadAssignments LeadAssignment[]
  callLogs        CallLog[]
  scripts         Script[]
  docs            Doc[]

  availabilityBlocks   AvailabilityBlock[]
  appointmentsAsSetter Appointment[]       @relation("Setter")
  appointmentsAsCloser Appointment[]       @relation("Closer")

  contractDrafts ContractDraft[]
  approvals      Approval[]

  portalServiceSetups PortalServiceSetup[]

  portalAccountMembersOwned PortalAccountMember[] @relation("PortalAccountMemberOwner")
  portalAccountMemberships  PortalAccountMember[] @relation("PortalAccountMemberUser")
  portalAccountInvites      PortalAccountInvite[] @relation("PortalAccountInviteOwner")

  portalTasks        PortalTask[] @relation("PortalTaskOwner")
  portalTasksAssigned PortalTask[] @relation("PortalTaskAssignee")
  businessProfile     BusinessProfile?
  portalMailboxAddress PortalMailboxAddress?
  clientBlogSite      ClientBlogSite?

  portalBookingSite   PortalBookingSite?

  portalReviews PortalReview[]
  portalReviewQuestions PortalReviewQuestion[]
  portalReviewPhotos PortalReviewPhoto[]
  portalContacts PortalContact[]

  portalContactServiceTriggers PortalContactServiceTrigger[]

  portalLeadScrapeRuns  PortalLeadScrapeRun[]
  portalLeads           PortalLead[] @relation("PortalLeadOwner")
  portalLeadsAssigned   PortalLead[] @relation("PortalLeadAssignee")

  portalBlogGenerationEvents PortalBlogGenerationEvent[]

  portalNewsletterGenerationEvents PortalNewsletterGenerationEvent[]
  portalNewsletterSendEvents PortalNewsletterSendEvent[]

  portalInboxThreads  PortalInboxThread[]
  portalInboxMessages PortalInboxMessage[]
  portalInboxAttachments PortalInboxAttachment[]

  portalContactTags PortalContactTag[]
  portalContactTagAssignments PortalContactTagAssignment[]

  portalMediaFolders PortalMediaFolder[]
  portalMediaItems   PortalMediaItem[]

  portalNurtureCampaigns  PortalNurtureCampaign[]
  portalNurtureSteps      PortalNurtureStep[]
  portalNurtureEnrollments PortalNurtureEnrollment[]

  portalAiOutboundCallCampaigns   PortalAiOutboundCallCampaign[]
  portalAiOutboundCallEnrollments PortalAiOutboundCallEnrollment[]
  portalAiOutboundCallManualCalls PortalAiOutboundCallManualCall[]
}

model PortalMediaFolder {
  id String @id @default(cuid())

  ownerId String
  parentId String?

  name    String
  nameKey String

  // Short per-owner tag you can reference elsewhere.
  tag String

  // Public share token for folder links.
  publicToken String

  // Optional display color for the folder icon in the UI.
  color String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner  User @relation(fields: [ownerId], references: [id])
  parent PortalMediaFolder? @relation("PortalMediaFolderTree", fields: [parentId], references: [id], onDelete: Cascade)
  children PortalMediaFolder[] @relation("PortalMediaFolderTree")

  items PortalMediaItem[]

  @@unique([ownerId, tag])
  @@index([ownerId, parentId, nameKey])
}

model PortalMediaItem {
  id String @id @default(cuid())

  ownerId String
  folderId String?

  fileName String
  mimeType String
  fileSize Int
  bytes    Bytes

  // Short per-owner tag you can reference elsewhere.
  tag String

  // Public share token for file links.
  publicToken String

  createdAt DateTime @default(now())

  owner  User @relation(fields: [ownerId], references: [id])
  folder PortalMediaFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@unique([ownerId, tag])
  @@index([ownerId, folderId, createdAt])
}

enum PortalLeadScrapeKind {
  B2B
  B2C
}

enum PortalLeadSource {
  GOOGLE_PLACES
}

model PortalLeadScrapeRun {
  id String @id @default(cuid())

  ownerId String
  kind    PortalLeadScrapeKind

  requestedCount Int @default(0)
  createdCount   Int @default(0)

  chargedCredits  Int @default(0)
  refundedCredits Int @default(0)

  settingsJson Json?
  error        String?

  createdAt DateTime @default(now())

  owner User @relation(fields: [ownerId], references: [id])

  @@index([ownerId, createdAt])
  @@index([ownerId, kind, createdAt])
}

model PortalLead {
  id String @id @default(cuid())

  ownerId String

  // Optional link to the normalized contact record.
  contactId String?

  // Optional assignment of this lead to a portal user (owner or member).
  assignedToUserId String?

  source PortalLeadSource @default(GOOGLE_PLACES)
  kind   PortalLeadScrapeKind @default(B2B)

  businessName String

  email String?

  phone   String?
  website String?
  address String?
  niche   String?

  starred Boolean @default(false)

  tag      String?
  tagColor String?

  placeId String?
  dataJson Json?

  createdAt DateTime @default(now())

  owner User @relation("PortalLeadOwner", fields: [ownerId], references: [id])

  assignedToUser User? @relation("PortalLeadAssignee", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  contact PortalContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@unique([ownerId, placeId])
  @@unique([ownerId, phone])
  @@index([ownerId, createdAt])
  @@index([ownerId, kind, createdAt])
  @@index([ownerId, starred, createdAt])
  @@index([ownerId, contactId])
  @@index([ownerId, assignedToUserId])
}

model PortalContact {
  id String @id @default(cuid())

  ownerId String

  name    String
  nameKey String

  email    String?
  emailKey String?

  phone    String?
  phoneKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])

  bookings PortalBooking[]
  reviews  PortalReview[]

  tagAssignments PortalContactTagAssignment[]

  inboxThreads PortalInboxThread[]
  portalLeads  PortalLead[]

  portalNurtureEnrollments PortalNurtureEnrollment[]

  portalAiOutboundCallEnrollments PortalAiOutboundCallEnrollment[]

  portalServiceTriggers PortalContactServiceTrigger[]

  @@index([ownerId])
  @@index([ownerId, emailKey])
  @@index([ownerId, phoneKey])
  @@index([ownerId, nameKey])
}

model PortalContactServiceTrigger {
  id String @id @default(cuid())

  ownerId String
  contactId String

  serviceSlug String

  triggerCount Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner   User         @relation(fields: [ownerId], references: [id])
  contact PortalContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([ownerId, contactId, serviceSlug])
  @@index([ownerId])
  @@index([ownerId, contactId])
  @@index([ownerId, serviceSlug])
  @@index([contactId])
}

model PortalContactTag {
  id String @id @default(cuid())

  ownerId String

  name    String
  nameKey String

  // Hex color like "#3b82f6" (optional).
  color String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])

  assignments PortalContactTagAssignment[]

  @@unique([ownerId, nameKey])
  @@index([ownerId])
}

model PortalContactTagAssignment {
  id String @id @default(cuid())

  ownerId   String
  contactId String
  tagId     String

  createdAt DateTime @default(now())

  owner   User           @relation(fields: [ownerId], references: [id])
  contact PortalContact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag     PortalContactTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contactId, tagId])
  @@index([ownerId, createdAt])
  @@index([tagId])
}

model Lead {
  id           String     @id @default(cuid())
  businessName String
  phone        String
  contactName  String?
  contactEmail String?
  contactPhone String?
  interestedService String?
  website      String?
  location     String?
  niche        String?
  notes        String?
  source       String?
  status       LeadStatus @default(NEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments  LeadAssignment[]
  callLogs     CallLog[]
  appointments Appointment[]
  docs         Doc[]

  marketingDemoRequest MarketingDemoRequest?
}

enum MarketingChannel {
  EMAIL
  SMS
}

enum MarketingMessageStatus {
  PENDING
  PROCESSING
  SENT
  SKIPPED
  FAILED
}

enum PortalNurtureCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum PortalNurtureStepKind {
  SMS
  EMAIL
}

enum PortalNurtureEnrollmentStatus {
  ACTIVE
  COMPLETED
  STOPPED
}

enum PortalAiOutboundCallCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum PortalAiOutboundCallEnrollmentStatus {
  QUEUED
  CALLING
  COMPLETED
  FAILED
  SKIPPED
}

enum PortalInboxChannel {
  EMAIL
  SMS
}

enum PortalInboxDirection {
  IN
  OUT
}

model PortalInboxThread {
  id String @id @default(cuid())

  ownerId String
  channel PortalInboxChannel

  // Stable key used for de-duping/lookup (e.g. other party + subject).
  threadKey String

  peerAddress String
  peerKey     String

  // Optional link to normalized contact (for tags/CRM).
  contactId String?

  subject    String?
  subjectKey String?

  lastMessageAt        DateTime @default(now())
  lastMessagePreview   String   @default("")
  lastMessageDirection PortalInboxDirection @default(IN)
  lastMessageFrom      String   @default("")
  lastMessageTo        String   @default("")
  lastMessageSubject   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User               @relation(fields: [ownerId], references: [id])
  contact  PortalContact?      @relation(fields: [contactId], references: [id], onDelete: SetNull)
  messages PortalInboxMessage[]

  @@unique([ownerId, channel, threadKey])
  @@index([ownerId, channel, lastMessageAt])
  @@index([ownerId, channel, peerKey])
  @@index([ownerId, contactId])
}

model PortalInboxMessage {
  id String @id @default(cuid())

  ownerId  String
  threadId String

  channel   PortalInboxChannel
  direction PortalInboxDirection

  fromAddress String
  toAddress   String

  subject String?
  bodyText String

  provider          String?
  providerMessageId String?

  createdAt DateTime @default(now())

  owner  User             @relation(fields: [ownerId], references: [id])
  thread PortalInboxThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  attachments PortalInboxAttachment[]

  @@index([threadId, createdAt])
  @@index([ownerId, channel, createdAt])
  @@index([providerMessageId])
}

model PortalInboxAttachment {
  id String @id @default(cuid())

  ownerId   String
  messageId String?

  fileName String
  mimeType String
  fileSize Int
  bytes    Bytes

  // Used to serve the attachment via a public URL (Twilio MMS needs a public fetchable URL).
  publicToken String

  createdAt DateTime @default(now())

  owner   User             @relation(fields: [ownerId], references: [id])
  message PortalInboxMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([ownerId, createdAt])
  @@index([messageId])
}

model PortalMailboxAddress {
  id String @id @default(cuid())

  ownerId String @unique

  // Local-part only, e.g. "acme-co" for acme-co@purelyautomation.com
  localPart String

  // Full email address for convenience.
  emailAddress String
  emailKey     String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])

  @@index([ownerId])
}

model MarketingDemoRequest {
  id      String @id @default(cuid())
  leadId  String @unique
  name    String
  company String
  email   String
  phone   String?
  optedIn Boolean @default(false)

  createdAt DateTime @default(now())

  lead     Lead              @relation(fields: [leadId], references: [id])
  messages MarketingMessage[]
}

model MarketingMessage {
  id        String @id @default(cuid())
  requestId String

  channel MarketingChannel
  to      String
  body    String
  sendAt  DateTime

  status MarketingMessageStatus @default(PENDING)
  sentAt  DateTime?
  error   String?

  createdAt DateTime @default(now())

  request MarketingDemoRequest @relation(fields: [requestId], references: [id])

  @@index([status, sendAt])
}

model PortalNurtureCampaign {
  id String @id @default(cuid())

  ownerId String

  name String
  status PortalNurtureCampaignStatus @default(DRAFT)

  // Tag-based audience (stored as string[])
  audienceTagIdsJson Json?

  // Optional footers appended to campaign messages.
  smsFooter   String @default("Reply STOP to opt out.")
  emailFooter String @default("")

  // Stripe-backed billing: $99 one-time install per campaign, $29/month per active campaign.
  installPaidAt DateTime?
  stripeSubscriptionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])

  steps       PortalNurtureStep[]
  enrollments PortalNurtureEnrollment[]

  @@index([ownerId, updatedAt])
  @@index([ownerId, status, updatedAt])
}

model PortalNurtureStep {
  id String @id @default(cuid())

  ownerId    String
  campaignId String

  ord Int
  kind PortalNurtureStepKind

  // Delay after the previous step is sent.
  delayMinutes Int @default(0)

  subject String?
  body    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User                 @relation(fields: [ownerId], references: [id])
  campaign PortalNurtureCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, ord])
  @@index([ownerId, campaignId])
}

model PortalNurtureEnrollment {
  id String @id @default(cuid())

  ownerId    String
  campaignId String
  contactId  String

  status PortalNurtureEnrollmentStatus @default(ACTIVE)

  // Index into the ordered steps list.
  stepIndex Int @default(0)

  nextSendAt DateTime?
  lastSentAt DateTime?
  lastError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User                 @relation(fields: [ownerId], references: [id])
  campaign PortalNurtureCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  PortalContact         @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([campaignId, contactId])
  @@index([ownerId, status, nextSendAt])
  @@index([campaignId, status, nextSendAt])
  @@index([ownerId, contactId])
}

model PortalAiOutboundCallCampaign {
  id String @id @default(cuid())

  ownerId String

  name   String
  status PortalAiOutboundCallCampaignStatus @default(DRAFT)

  // Tag-based audience (stored as string[])
  audienceTagIdsJson Json?

  // Script read aloud on connect.
  script String @default("Hi â€” this is an automated call. Please call us back when you have a moment.")

  // Optional ElevenLabs agent id override for this campaign.
  voiceAgentId String?

  // Optional ElevenLabs agent configuration payload (personality/goal/tone/tools/first message).
  voiceAgentConfigJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner       User                        @relation(fields: [ownerId], references: [id])
  enrollments PortalAiOutboundCallEnrollment[]
  manualCalls PortalAiOutboundCallManualCall[]

  @@index([ownerId, updatedAt])
  @@index([ownerId, status, updatedAt])
}

model PortalAiOutboundCallEnrollment {
  id String @id @default(cuid())

  ownerId    String
  campaignId String
  contactId  String

  status PortalAiOutboundCallEnrollmentStatus @default(QUEUED)

  nextCallAt    DateTime?
  callSid       String?
  attemptCount  Int      @default(0)
  lastError     String?
  completedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User                       @relation(fields: [ownerId], references: [id])
  campaign PortalAiOutboundCallCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  PortalContact                @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([campaignId, contactId])
  @@index([ownerId, status, nextCallAt])
  @@index([campaignId, status, nextCallAt])
  @@index([ownerId, contactId])
}

model PortalAiOutboundCallManualCall {
  id String @id @default(cuid())

  ownerId    String
  campaignId String?

  webhookToken String @unique

  toNumberE164  String
  status        String @default("CALLING")

  callSid        String?
  conversationId String?
  recordingSid   String?
  recordingDurationSec Int?
  transcriptText String?
  lastError      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User                         @relation(fields: [ownerId], references: [id])
  campaign PortalAiOutboundCallCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([ownerId, createdAt])
  @@index([ownerId, campaignId, createdAt])
}

model LeadAssignment {
  id         String    @id @default(cuid())
  leadId     String
  userId     String
  claimedAt  DateTime  @default(now())
  releasedAt DateTime?

  lead Lead @relation(fields: [leadId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([leadId, releasedAt])
  @@index([userId])
  @@index([leadId])
}

model Script {
  id         String  @id @default(cuid())
  ownerId    String
  title      String
  content    String
  isTemplate Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])

  @@index([ownerId])
}

model Doc {
  id      String @id @default(cuid())
  ownerId String
  leadId  String?
  title   String
  content String
  kind    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])
  lead  Lead? @relation(fields: [leadId], references: [id])

  callLogTranscripts CallLog[]       @relation("CallLogTranscript")
  appointmentPreps   Appointment[]   @relation("AppointmentPrep")
  contractAiDocs     ContractDraft[] @relation("ContractAiDoc")

  @@index([ownerId])
  @@index([leadId])
  @@unique([ownerId, leadId, kind])
}

model CallLog {
  id          String          @id @default(cuid())
  dialerId    String
  leadId      String
  disposition CallDisposition

  contactName  String?
  contactEmail String?
  contactPhone String?
  companyName  String?
  method       AppointmentMethod?
  methodOther  String?

  notes       String?
  followUpAt  DateTime?

  createdAt DateTime @default(now())

  dialer User @relation(fields: [dialerId], references: [id])
  lead   Lead @relation(fields: [leadId], references: [id])

  recording         CallRecording?
  transcriptDocId   String?
  transcriptDoc     Doc?           @relation("CallLogTranscript", fields: [transcriptDocId], references: [id])
  bookedAppointment Appointment?

  @@index([dialerId])
  @@index([leadId])
}

model CallRecording {
  id        String @id @default(cuid())
  callLogId String @unique
  filePath  String
  mimeType  String
  fileSize  Int

  createdAt DateTime @default(now())

  callLog CallLog @relation(fields: [callLogId], references: [id])
}

model AppointmentVideo {
  id            String @id @default(cuid())
  appointmentId String @unique
  filePath      String
  mimeType      String
  fileSize      Int

  createdAt DateTime @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id])
}

model AvailabilityBlock {
  id      String   @id @default(cuid())
  userId  String
  startAt DateTime
  endAt   DateTime

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, startAt])
}

model Appointment {
  id       String            @id @default(cuid())
  leadId   String
  setterId String
  closerId String
  startAt  DateTime
  endAt    DateTime
  status   AppointmentStatus @default(SCHEDULED)

  meetingPlatform          String?
  meetingJoinUrl           String?
  meetingJoinUrlSetAt      DateTime?
  meetingJoinUrlSetByUserId String?
  meetingReminder24hSentAt DateTime?
  meetingReminder1hSentAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lead   Lead @relation(fields: [leadId], references: [id])
  setter User @relation("Setter", fields: [setterId], references: [id])
  closer User @relation("Closer", fields: [closerId], references: [id])

  callLogId String?  @unique
  callLog   CallLog? @relation(fields: [callLogId], references: [id])

  outcome   AppointmentOutcome?
  prepDocId String?
  prepDoc   Doc?                @relation("AppointmentPrep", fields: [prepDocId], references: [id])

  loomUrl String?

  video AppointmentVideo?

  @@index([closerId, startAt])
  @@index([setterId, startAt])
}

model AppointmentOutcome {
  id            String        @id @default(cuid())
  appointmentId String        @unique
  outcome       CloserOutcome
  notes         String?
  revenueCents  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id])

  contractDraft ContractDraft?
}

model ContractDraft {
  id                   String         @id @default(cuid())
  appointmentOutcomeId String         @unique
  status               ContractStatus @default(DRAFT)

  priceCents  Int
  setupFeeCents   Int  @default(0)
  monthlyFeeCents Int  @default(0)
  termMonths      Int  @default(0)
  servicesJson    Json?
  servicesOther   String?
  terms       String
  services    String
  clientEmail String?

  aiDocId String?
  aiDoc   Doc?    @relation("ContractAiDoc", fields: [aiDocId], references: [id])

  submittedByUserId String
  submittedByUser   User   @relation(fields: [submittedByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  approvals Approval[]

  appointmentOutcome AppointmentOutcome @relation(fields: [appointmentOutcomeId], references: [id])

  @@index([status])
}

model Approval {
  id              String  @id @default(cuid())
  contractDraftId String
  reviewerId      String
  decision        String
  notes           String?

  createdAt DateTime @default(now())

  contractDraft ContractDraft @relation(fields: [contractDraftId], references: [id])
  reviewer      User          @relation(fields: [reviewerId], references: [id])

  @@index([contractDraftId])
  @@index([reviewerId])
}

model BlogPost {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  excerpt     String
  content     String
  seoKeywords Json?

  publishedAt DateTime @default(now())

  archivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([publishedAt])
  @@index([archivedAt])
}

model BlogAutomationSettings {
  id String @id @default("singleton")

  weeklyEnabled Boolean @default(true)

  // Optional manager-curated list of future topics. When present,
  // the weekly cron will use topics in order via topicQueueCursor.
  topicQueue       Json?
  topicQueueCursor Int  @default(0)

  lastWeeklyRunAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PortalServiceSetupStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETE
}

model PortalServiceSetup {
  id String @id @default(cuid())

  ownerId    String
  serviceSlug String
  status     PortalServiceSetupStatus @default(NOT_STARTED)
  dataJson   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])

  @@unique([ownerId, serviceSlug])
  @@index([ownerId])
}

model BusinessProfile {
  id String @id @default(cuid())

  ownerId String @unique

  businessName   String
  websiteUrl     String?
  industry       String?
  businessModel  String?
  primaryGoals   Json?
  targetCustomer String?
  brandVoice     String?

  logoUrl        String?
  brandPrimaryHex String?
  brandAccentHex  String?
  brandTextHex    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])
}

enum ClientBlogPostStatus {
  DRAFT
  PUBLISHED
}

enum PortalBlogGenerationSource {
  CRON
  GENERATE_NOW
  DRAFT_GENERATE
}

enum ClientNewsletterKind {
  EXTERNAL
  INTERNAL
}

enum ClientNewsletterStatus {
  DRAFT
  READY
  SENT
}

enum PortalNewsletterGenerationSource {
  CRON
  GENERATE_NOW
}

enum PortalNewsletterSendChannel {
  EMAIL
  SMS
}

model ClientBlogSite {
  id String @id @default(cuid())

  ownerId String @unique
  name    String

  // Public slug hosted under /<slug>/blogs
  slug    String? @unique

  // Optional custom domain the customer wants to use.
  primaryDomain      String?
  verificationToken  String
  verifiedAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])
  posts ClientBlogPost[]
  blogGenerationEvents PortalBlogGenerationEvent[]

  newsletters ClientNewsletter[]
  newsletterGenerationEvents PortalNewsletterGenerationEvent[]
  newsletterSendEvents PortalNewsletterSendEvent[]

  @@index([ownerId])
  @@index([primaryDomain])
}

model PortalBlogGenerationEvent {
  id String @id @default(cuid())

  ownerId String
  siteId  String
  postId  String?

  source PortalBlogGenerationSource
  chargedCredits Int @default(1)
  topic String?

  createdAt DateTime @default(now())

  owner User @relation(fields: [ownerId], references: [id])
  site  ClientBlogSite @relation(fields: [siteId], references: [id], onDelete: Cascade)
  post  ClientBlogPost? @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([ownerId, createdAt])
  @@index([siteId, createdAt])
  @@index([postId])
}

model ClientBlogPost {
  id String @id @default(cuid())

  siteId  String
  status  ClientBlogPostStatus @default(DRAFT)

  slug    String
  title   String
  excerpt String
  content String
  seoKeywords Json?

  publishedAt DateTime?
  archivedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site ClientBlogSite @relation(fields: [siteId], references: [id])
  blogGenerationEvents PortalBlogGenerationEvent[]

  @@unique([siteId, slug])
  @@index([siteId, status, publishedAt])
  @@index([siteId, archivedAt])
}

model ClientNewsletter {
  id String @id @default(cuid())

  siteId String
  kind   ClientNewsletterKind
  status ClientNewsletterStatus @default(DRAFT)

  slug    String
  title   String
  excerpt String
  content String

  smsText String?

  sentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site ClientBlogSite @relation(fields: [siteId], references: [id], onDelete: Cascade)

  generationEvents PortalNewsletterGenerationEvent[]
  sendEvents PortalNewsletterSendEvent[]

  @@unique([siteId, kind, slug])
  @@index([siteId, kind, createdAt])
  @@index([siteId, kind, status, sentAt])
}

model PortalNewsletterGenerationEvent {
  id String @id @default(cuid())

  ownerId      String
  siteId       String
  newsletterId String?

  source PortalNewsletterGenerationSource
  chargedCredits Int @default(1)
  kind ClientNewsletterKind

  createdAt DateTime @default(now())

  owner User @relation(fields: [ownerId], references: [id])
  site  ClientBlogSite @relation(fields: [siteId], references: [id], onDelete: Cascade)
  newsletter ClientNewsletter? @relation(fields: [newsletterId], references: [id], onDelete: SetNull)

  @@index([ownerId, createdAt])
  @@index([siteId, createdAt])
  @@index([newsletterId])
}

model PortalNewsletterSendEvent {
  id String @id @default(cuid())

  ownerId      String
  siteId       String
  newsletterId String

  channel PortalNewsletterSendChannel
  kind ClientNewsletterKind

  requestedCount Int @default(0)
  sentCount      Int @default(0)
  failedCount    Int @default(0)
  errorsJson     Json?

  createdAt DateTime @default(now())

  owner User @relation(fields: [ownerId], references: [id])
  site  ClientBlogSite @relation(fields: [siteId], references: [id], onDelete: Cascade)
  newsletter ClientNewsletter @relation(fields: [newsletterId], references: [id], onDelete: Cascade)

  @@index([ownerId, createdAt])
  @@index([siteId, createdAt])
  @@index([newsletterId, createdAt])
}

model PortalReview {
  id String @id @default(cuid())

  ownerId String

  rating Int
  name   String
  body   String?

  email String?
  phone String?

  contactId String?
  contact   PortalContact? @relation(fields: [contactId], references: [id])

  photoUrls Json?

  answersJson Json?

  businessReply   String?
  businessReplyAt DateTime?

  archivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])

  photos PortalReviewPhoto[]

  @@index([ownerId, archivedAt, createdAt])
  @@index([ownerId, contactId])
}

model PortalReviewQuestion {
  id String @id @default(cuid())

  ownerId String

  name     String
  question String

  answer     String?
  answeredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id])

  @@index([ownerId, createdAt])
  @@index([ownerId, answeredAt])
}

model PortalReviewPhoto {
  id String @id @default(cuid())

  ownerId  String
  reviewId String

  contentType String
  bytes       Bytes

  createdAt DateTime @default(now())

  owner  User        @relation(fields: [ownerId], references: [id])
  review PortalReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([reviewId])
}

enum PortalBookingStatus {
  SCHEDULED
  CANCELED
}

enum PortalAccountRole {
  OWNER
  ADMIN
  MEMBER
}

enum PortalTaskStatus {
  OPEN
  DONE
  CANCELED
}

model PortalBookingSite {
  id String @id @default(cuid())

  ownerId String @unique
  slug    String @unique

  enabled         Boolean @default(false)
  title           String  @default("Book a call")
  description     String?
  durationMinutes Int     @default(30)
  timeZone        String  @default("America/New_York")

  photoUrl           String?
  notificationEmails Json?
  appointmentPurpose String?
  toneDirection      String?
  meetingLocation    String?
  meetingDetails     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User            @relation(fields: [ownerId], references: [id])
  bookings PortalBooking[]
}

model PortalBooking {
  id String @id @default(cuid())

  siteId String

  startAt DateTime
  endAt   DateTime
  status  PortalBookingStatus @default(SCHEDULED)

  calendarId String?

  contactName  String
  contactEmail String
  contactPhone String?

  contactId String?
  contact   PortalContact? @relation(fields: [contactId], references: [id])
  notes        String?

  canceledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site PortalBookingSite @relation(fields: [siteId], references: [id])

  @@index([siteId, startAt])
  @@index([siteId, status, startAt])
  @@index([siteId, calendarId, endAt])
}

model PortalAccountMember {
  id String @id @default(cuid())

  ownerId String
  userId  String

  role PortalAccountRole @default(MEMBER)

  // Optional per-section access control. When null, defaults to full access.
  permissionsJson Json?

  createdAt DateTime @default(now())

  owner User @relation("PortalAccountMemberOwner", fields: [ownerId], references: [id])
  user  User @relation("PortalAccountMemberUser", fields: [userId], references: [id])

  @@unique([ownerId, userId])
  @@index([ownerId])
  @@index([userId])
}

model PortalAccountInvite {
  id String @id @default(cuid())

  ownerId String
  email   String

  role PortalAccountRole @default(MEMBER)
  permissionsJson Json?

  token     String   @unique
  expiresAt DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  owner User @relation("PortalAccountInviteOwner", fields: [ownerId], references: [id])

  @@index([ownerId, createdAt])
  @@index([email])
}

model PortalTask {
  id String @id @default(cuid())

  ownerId String

  title       String
  description String?
  status      PortalTaskStatus @default(OPEN)

  assignedToUserId String?
  assignedToUser   User? @relation("PortalTaskAssignee", fields: [assignedToUserId], references: [id])

  dueAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation("PortalTaskOwner", fields: [ownerId], references: [id])

  @@index([ownerId, status, updatedAt])
  @@index([ownerId, assignedToUserId, status])
}
